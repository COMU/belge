<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-9"><meta name="date" content="2008-10-11T01:26:08+03:00"><title>KAME-tools kullanan Linux 2.6 Çekirdeði</title><link rel="icon" type="image/png" href="../images/belgeler-logo.png"><link rel="stylesheet" href="../belgeler.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V-special(derived from 1.49 for Turkish Linux Documentation WG by Nilgün Belma Bugüner - nilgun@superonline.com)"><link rel="home" href="../KiTAPLIK/index.html" title="Linux Kitaplýðý"><link rel="up" href="../howto/ipsec-howto.html" title="IPsec NASIL"><link rel="previous" href="../howto/ipsec-howto-openswan.html" title="Linux 2.6 Üzerinde Çalýþan Openswan"><link rel="next" href="../howto/ipsec-howto-isakmpd.html" title="OpenBSD'nin isakmpd aracýný kullanýlan Linux 2.6 Çekirdeði"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><table width="100%" summary="Navigation header" cellpadding="1" cellspacing="0" border="0"><tr><td bgcolor="black" class="navoutline"><table width="100%" cellpadding="0" cellspacing="0" border="0"><tr><td bgcolor="white" class="navinline"><table width="100%" cellpadding="3" cellspacing="0" border="0"><tr><th colspan="3" align="center">KAME-tools kullanan Linux 2.6 Çekirdeði</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="../howto/ipsec-howto-openswan.html">Önceki</a> </td><th width="60%" align="center">IPsec NASIL</th><td width="20%" align="right"> <a accesskey="n" href="../howto/ipsec-howto-isakmpd.html">Sonraki</a></td></tr></table></td></tr></table></td></tr></table><dl><div class="sect1"><dt><div> <h2 class="title" style="clear: both"><a name="ipsec-howto-kametools"></a>KAME-tools kullanan Linux 2.6 Çekirdeði</h2></div></dt><dd><p>Bu bölümde Linux çekirdeðinin &#8805;2.5.47 ve 2.6.* serilerinde doðal IPsec yýðýnýnýn (stack) nasýl kullanýlacaðý açýklanacaktýr. Bu IPsec yýðýnýnýn kurulumu ve yapýladýrmasý FreeS/WAN'dan oldukça farklýdýr ve FreeBSD, NetBSD ve OpenBSD gibi *BSD türevlerine benzer.</p><p>Ýlk olarak Linux çekirdeðinin ve kullanýcý araçlarýnýn kurulum ve yapýlandýrmalarýndan bahsedeceðim.  Daha sonra taþýma ve tünel modlarýnda elle yapýlandýrýlan baðlantýlarýn ayarlanmasýný anlatacaðým. Son olarak, önceden paylaþýlmýþ anahtarlar ve X.509 sertifikalrý kullanan otomatik anahtarlamalý baðlantýlarýn kurulmasýnýn üzerinden geçeceðiz. Roadwarriors için destekle bu bölüm sonlanacak.</p><dl><div class="sect2"><dt><div> <h3 class="title"><a name="ipsec-howto-kametools-installation"></a>Kurulum</h3></div></dt><dd><p>Kurulum için kullanacaðýnýz Linux çekirdeði en azýndan 2.5.47 veya 2.6.* olmalýdýr. Çekirdeðin kaynak kodlarýný <a href="http://www.kernel.org" target="_top">http://www.kernel.org</a> adresinden indirebilirsiniz. Ýndirdikten sonta açýp, yapýlandýrýp derlemeniz gerekecektir.<div class="screen" align="right"><table width="95%" cellpadding="5" cellspacing="1" border="0" class="preoutline"><tr class="preinline"><td> <pre class="screen">cd /usr/local/src
tar xvjf /path-to-source/linux-&lt;version&gt;.tar.bz2
cd linux-&lt;version&gt;
make xconfig
make bzImage
make modules
make modules_install
make install</pre> </td></tr></table></div>
		</p><p>Bunlar Linux çekirdeðinin yapýlandýrýlýp derlenmesinde en sýk kullanýlan çekirdek parametreleridir. Eðer özel bir kuruluma ihtiyacýnýz varsa Çekirdek NASIL belgesinden yararlanabilirsiniz.</p><p>Çekirdeði yapýlandýrýrken aþaðýdaki özellikleri aktif hale getirmek önemldir:<div class="screen" align="right"><table width="95%" cellpadding="5" cellspacing="1" border="0" class="preoutline"><tr class="preinline"><td> <pre class="screen">Networking support (NET) [Y/n/?] y
*
* Networking options
*
PF_KEY sockets (NET_KEY) [Y/n/m/?] y
IP: AH transformation (INET_AH) [Y/n/m/?] y
IP: ESP transformation (INET_ESP) [Y/n/m/?] y
IP: IPsec user configuration interface (XFRM_USER) [Y/n/m/?] y

Cryptographic API (CRYPTO) [Y/n/?] y
HMAC support (CRYPTO_HMAC) [Y/n/?] y
Null algorithms (CRYPTO_NULL) [Y/n/m/?] y
MD5 digest algorithm (CRYPTO_MD5) [Y/n/m/?] y
SHA1 digest algorithm (CRYPTO_SHA1) [Y/n/m/?] y
DES and Triple DES EDE cipher algorithms (CRYPTO_DES) [Y/n/m/?] y
AES cipher algorithms (CRYPTO_AES) [Y/n/m/?] y</pre> </td></tr></table></div>
		</p><p>Kullandýðýnýz çekirdeðin sürümüne baðlý olarak IPv6 desteðini de açmanýz gerekebilir.</p><p>Çekirdek derlenip kuruduktan sonra kullanýcý araçlarýnýn kurulumuna geçilebilir. Bu araçlarý <a href="http://ipsec-tools.sourceforge.net/" target="_top">http://ipsec-tools.sourceforge.net/</a> adresinden indirebilirsiniz. Paketi elle derlerken çekirdek baþlýklarýnýn (kernel headers) nerede olduðunu belirtmeniz gerekebilir. Çekirdek baþlýklarýnýn en azýndan 2.5.47 sürümüne ait olmasý gereklidir.<div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0"><tr><td rowspan="2" align="center" valign="top" width="25"><img src="../images/xsl/warning.png"></td><th>Uyarý</th></tr><tr><td colspan="2" align="left" valign="top">Eðer çekirdek sürümünüz &gt;= 2.6.10 ise kullanacaðýnýz ipsec-tools da &gt;= 0.5 olmak zorundadýr, çünkü bu çekirdeðe daha eski ipsec-tools sürümlerindeki racoon için tanýmlý olmayan yeni yönlendirme politikalarý eklenmiþtir. Bazý Linux daðýtýmlarýnýn eski çekirdekler kullansalar bile çokça yama yapýyor olabileceklerini hesaba katýn. Bunun için çekirdeðinizdeki yönlendirme politikalarýna bakmanýz yeterli olacaktýr.</td></tr></table></div>
		<div class="screen" align="right"><table width="95%" cellpadding="5" cellspacing="1" border="0" class="preoutline"><tr class="preinline"><td> <pre class="screen">./configure --with-kernel-headers=/lib/modules/2.6.X/build/include
make
make install</pre> </td></tr></table></div></p><p>Artýk devam etmek için herþey hazýr olmalýdýr.</p></dd></div></dl><dl><div class="sect2"><dt><div> <h3 class="title"><a name="ipsec-howto-kametools-setkey"></a><b><tt>setkey</tt></b> kullanan elle anahtarlanmýþ baðlantýlar</h3></div></dt><dd><p>Elle anahtarlanmýþ baðlantý derken baðlantýnýn kurulumu için gerekli tüm parametrelerin bir yönetici tarafýndan atandýðý baðlantýlarý kastediyorum. IKE protokolü taraflarýn kimlik kanýtlamasýný otomatik olarak yapmaz ve gerekli parametreleri belirlemez. Güvenlik anlaþmasýnýn tesisinde hangi protokolün, algoritmanýn ve anahtarýn kullanacaðýna ve uygun þekilde güvenlik anlaþmasý veritabanýna (SAD) yazýlacaðýna yönetici karar verir.</p><dl><div class="sect3"><dt><div> <h4 class="title"><a name="ipsec-howto-kametools-setkey-transport"></a>Taþýma Modu</h4></div></dt><dd><p>Bu bölümde önce taþýma modunda nasýl elle anahtarlanmýþ baðlantýnýn kurulacaðýný göreceðiz. Bu baþlangýç için en iyi yöntemdir çünkü kurulabilecek en basit baðlantý budur. Örnek olarak 192.168.1.100 ve 192.168.2.100 adreslerine sahip iki bilgisayarýn IPsec ile haberleþtiðini varsayacaðýz.</p><p>SAD ve SPD'de bulunan bütün parametreler <b><tt>setkey</tt></b> komutuyla deðiþtirilebilir. Bu komutun kýlavuz belgesi oldukça açýklayýcý olduðundan burada sadece taþýma modunda bir baðlantý kurulmasý için ihtiyaç duyulan parametreler açýklanacaktýr. <b><tt>setkey</tt></b> eðer <b><tt>setkey -f /etc/setkey.conf</tt></b> þeklinde kullanýlýrsa istediðiniz bir yapýlandýrma dosyasýný kullanabilir. Uygun bir <tt>/etc/setkey.conf</tt> dosyasý aþaðýda verilmiþtir.<div class="screen" align="right"><table width="95%" cellpadding="5" cellspacing="1" border="0" class="preoutline"><tr class="preinline"><td> <pre class="screen">#!/usr/sbin/setkey -f

# Configuration for 192.168.1.100

# Flush the SAD and SPD
flush;
spdflush;

# Attention: Use this keys only for testing purposes!
# Generate your own keys!

# AH SAs using 128 bit long keys
add 192.168.1.100 192.168.2.100 ah 0x200 -A hmac-md5 
0xc0291ff014dccdd03874d9e8e4cdf3e6;
add 192.168.2.100 192.168.1.100 ah 0x300 -A hmac-md5 
0x96358c90783bbfa3d7b196ceabe0536b;

# ESP SAs using 192 bit long keys (168 + 24 parity)
add 192.168.1.100 192.168.2.100 esp 0x201 -E 3des-cbc 
0x7aeaca3f87d060a12f4a4487d5a5c3355920fae69a96c831;
add 192.168.2.100 192.168.1.100 esp 0x301 -E 3des-cbc 
0xf6ddb555acfd9d77b03ea3843f2653255afe8eb5573965df;

# Security policies
spdadd 192.168.1.100 192.168.2.100 any -P out ipsec
esp/transport//require
ah/transport//require;

spdadd 192.168.2.100 192.168.1.100 any -P in ipsec
esp/transport//require
ah/transport//require;</pre> </td></tr></table></div></p><p>Elle anahtarlanan baðlantýnýzý test amacý dýþýnda herhangi bir iþ için kullanacaksanýz yukarýdaki betikteki anahtarlarý deðiþtirmeniz gerekir. Kendi anahtarlarýnýzý aþaðýdaki komutla yaratabilirsiniz:	
		<div class="screen" align="right"><table width="95%" cellpadding="5" cellspacing="1" border="0" class="preoutline"><tr class="preinline"><td> <pre class="screen">$ # 128 Bit long key
$ dd if=/dev/random count=16 bs=1| xxd -ps
16+0 Records ein
16+0 Records aus
cd0456eff95c5529ea9e918043e19cbe

$ # 192 Bit long key
$ dd if=/dev/random count=24 bs=1| xxd -ps
24+0 Records ein
24+0 Records aus
9d6c4a8275ab12fbfdcaf01f0ba9dcfb5f424c878e97f888</pre> </td></tr></table></div></p><p>Anahtarlarýnýzý yaratýrken lütfen gerçekten rasgele anahtar ürettiðinden emin olabileceðiniz <tt>/dev/random</tt> aygýtýný kullanýn.</p><p>Betik ilk olarak güvenlik anlaþmasý veritabanýný (SAD) ve güvenlik politikasý veritabanýný (SPD) temizler. Daha sonra AH SA ve ESP SA'larý oluþturur. Bir güvenlik anlaþmasý SAD'a <b><tt>add</tt></b> komutu ile eklenir. Bu komut parametre olarak kaynak ve hedef IP adreslerine, IPsec protokolüne (<b><tt>ah</tt></b>), SPI (<b><tt>0x200</tt></b>) ve algoritma bilgilerine ihtiyaç duyar. Kimlik denetleme algoritmasý <b><tt>-A</tt></b> ile belirtilir (þifreleme için <b><tt>-E</tt></b>, sýkýþtýrma için <b><tt>-C</tt></b> kullanýlýr, henüz IP sýkýþtýrmasý desteklenmemektedir). Algoritma içinde anahtar mutlaka belirtilmelidir. Anahtar çift týrnak içinde &#8220;ASCII&#8221; veya <b><tt>0x</tt></b>'i takip eden heksadesimal biçimde yazýlabilir.</p><p>Linux AH ve ESP için þu algoritmalarý destekler: hmac-md5 and hmac-sha, des-cbc ve 3des-cbc. Kýsa bir zaman sonra þu algoritmalar da muhtemelen desteklenecektir: basit (þifrelemesiz), blowfish-cbc, aes-cbc, hmac-sha2-256 ve hmac-sha2-512.</p><p>SPD'ye güvenlik politikalarý <b><tt>spdadd</tt></b> komutu ile eklenir. Hangi paketlerin IPsec ile korunacaðý ve hangi protokol ve anahtarlarýn kullanýlacaðýný bu politikalar belirler. Bu komut da parametre olarak korunacak paketlerin kaynak ve hedef IP adresine, korunacak (herhangi bir) protokole (ve porta) ve kullanýlacak politikaya (<b><tt>-P</tt></b>) ihtiyaç duyar. Politika yönü (içeri/dýþarý), uygulanacak iþlemi (ipsec/discard/none), protokolü (ah/esp/ipcomp), modu (transport) ve seviyeyi (use/require) belirler.</p><p>Bu yapýlandýrma dosyasý IPsec iletiþiminde yer alacak her iki tarafta da oluþturulmalýdýr. Yukarýdaki dosya 192.168.1.100 adresli tarafta hiç bir deðiþikliðe ihtiyaç duymadan çalýþýrken 192.168.2.100 adresine sahip tarafta paketlerinin yönünün deðiþtiðini göstermek üzere hafifçe deðiþtirilmelidir. Bunun en kolay yolu güvenlik politikalarýndaki yönleri deðiþtirmektir: <b><tt>-P in</tt></b> ile <b><tt>-P out</tt></b>'nin yerlerini deðiþtirmektir. Aþaðýda örnek bir dosya var:<div class="screen" align="right"><table width="95%" cellpadding="5" cellspacing="1" border="0" class="preoutline"><tr class="preinline"><td> <pre class="screen">#!/usr/sbin/setkey -f

# Configuration for 192.168.2.100

# Flush the SAD and SPD
flush;
spdflush;

# Attention: Use this keys only for testing purposes!
# Generate your own keys!

# AH SAs using 128 bit long keys
add 192.168.1.100 192.168.2.100 ah 0x200 -A hmac-md5 
0xc0291ff014dccdd03874d9e8e4cdf3e6;
add 192.168.2.100 192.168.1.100 ah 0x300 -A hmac-md5 
0x96358c90783bbfa3d7b196ceabe0536b;

# ESP SAs using 192 bit long keys (168 + 24 parity)
add 192.168.1.100 192.168.2.100 esp 0x201 -E 3des-cbc 
0x7aeaca3f87d060a12f4a4487d5a5c3355920fae69a96c831;
add 192.168.2.100 192.168.1.100 esp 0x301 -E 3des-cbc 
0xf6ddb555acfd9d77b03ea3843f2653255afe8eb5573965df;

# Security policies
spdadd 192.168.1.100 192.168.2.100 any -P in ipsec
esp/transport//require
ah/transport//require;

spdadd 192.168.2.100 192.168.1.100 any -P out ipsec
esp/transport//require
ah/transport//require;</pre> </td></tr></table></div></p><p>Yapýlandýrma dosyasý taraflardaki yerini aldýðýnda <b><tt>setkey -f /etc/setkey.conf</tt></b> komutuyla yüklenebilir. Yüklemenin baþarýlý olup olmadýðý SAD ve SPD görüntülenerek test edilebilir:<div class="screen" align="right"><table width="95%" cellpadding="5" cellspacing="1" border="0" class="preoutline"><tr class="preinline"><td> <pre class="screen"># setkey -D
# setkey -DP</pre> </td></tr></table></div></p><p>Kurulum <a href="../howto/ipsec-howto-kametools.html#ipsec-howto-transportt" title="Þekil 4.4. Taþýma modunda AH ve ESP kullanan iki bilgisayar">Þekil 4.4</a>'te gösterilmektedir.</p><p><div class="figure"><p><a name="ipsec-howto-transportt"></a><b>Þekil 4.4. Taþýma modunda AH ve ESP kullanan iki bilgisayar</b></p><div class="mediaobject"><img src="images/ipsec/transport.png" align="center"></div></div>
		</p><p>Taraflardan birinden diðerini pinglediðinizde trafik þifrelenecek ve tcpdump aþaðýdaki paketleri gösterecektir:<div class="screen" align="right"><table width="95%" cellpadding="5" cellspacing="1" border="0" class="preoutline"><tr class="preinline"><td> <pre class="screen">12:45:39.373005 192.168.1.100 &gt; 192.168.2.100: AH(spi=0x00000200,seq=0x1): 
ESP(spi=0x00000201,seq=0x1) (DF)
12:45:39.448636 192.168.2.100 &gt; 192.168.1.100: AH(spi=0x00000300,seq=0x1): 
ESP(spi=0x00000301,seq=0x1)
12:45:40.542430 192.168.1.100 &gt; 192.168.2.100: AH(spi=0x00000200,seq=0x2): 
ESP(spi=0x00000201,seq=0x2) (DF)
12:45:40.569414 192.168.2.100 &gt; 192.168.1.100: AH(spi=0x00000300,seq=0x2): 
ESP(spi=0x00000301,seq=0x2)</pre> </td></tr></table></div></p></dd></div></dl><dl><div class="sect3"><dt><div> <h4 class="title"><a name="ipsec-howto-kametools-setkey-tunnel"></a>Tünel Modu</h4></div></dt><dd><p>Tünel modu her iki taraf da að geçidi olarak çalýþtýðýnda ve iki að arasýndaki trafiði koruduðunda kullanýlýr (<a href="../howto/ipsec-howto-kametools.html#ipsec-howto-tunel" title="Þekil 4.5. Ýki að arasýndaki trafiði koruyan iki bilgisayar">Þekil 4.5</a>). Orjinal IP paketleri bir að geçidinden diðerine gönderilirken þifrelenir ve kapsüllenir. Karþý taraf ise paketin kapsülünü açar ve orjinal korumasýz paketin geçiþine izin verir.</p><p><div class="figure"><p><a name="ipsec-howto-tunel"></a><b>Þekil 4.5. Ýki að arasýndaki trafiði koruyan iki bilgisayar</b></p><div class="mediaobject"><img src="images/ipsec/tunnel.png" align="center"></div></div>
		</p><p>Güvenlik anlaþmalarýnýn ve politikalarýn yapýlandýrmasý taþýma moduna çok benzer. Aþaðýda bir örneði bulunmaktadýr:<div class="screen" align="right"><table width="95%" cellpadding="5" cellspacing="1" border="0" class="preoutline"><tr class="preinline"><td> <pre class="screen">#!/usr/sbin/setkey -f

# Flush the SAD and SPD
flush;
spdflush;

# ESP SAs doing encryption using 192 bit long keys (168 + 24 parity)
# and authentication using 128 bit long keys
add 192.168.1.100 192.168.2.100 esp 0x201 -m tunnel -E 3des-cbc 
0x7aeaca3f87d060a12f4a4487d5a5c3355920fae69a96c831 
-A hmac-md5 0xc0291ff014dccdd03874d9e8e4cdf3e6;

add 192.168.2.100 192.168.1.100 esp 0x301 -m tunnel -E 3des-cbc 
0xf6ddb555acfd9d77b03ea3843f2653255afe8eb5573965df 
-A hmac-md5 0x96358c90783bbfa3d7b196ceabe0536b;

# Security policies
spdadd 172.16.1.0/24 172.16.2.0/24 any -P out ipsec
esp/tunnel/192.168.1.100-192.168.2.100/require;

spdadd 172.16.2.0/24 172.16.1.0/24 any -P in ipsec
esp/tunnel/192.168.2.100-192.168.1.100/require;</pre> </td></tr></table></div>
<div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0"><tr><td rowspan="2" align="center" valign="top" width="25"><img src="../images/xsl/warning.png"></td><th>Uyarý</th></tr><tr><td colspan="2" align="left" valign="top">Kullandýðýnýz Linux çekirdeði 2.6.10 veya daha üstü ise ve paketlerin bilgisayardan dýþarý yönlendirilmesi gerekiyorsa ayrýca yönlendirme politikasýný da belirtmeniz gerekir. Eðer ipsec-tools'un 0.5 sürümünü kullanýrsanýz bu politika otomatik olarak yüklenir aksi halde eski araçlarý kullanarak kendiniz eklemeniz gerekir. <b><tt>setkey</tt></b> komutunu Çekirdek modunda (<b><tt>-k</tt></b>) çalýþtýrýyprsanýz yönlendirme politikasýný da elle eklemeniz gerekir.</td></tr></table></div>
<div class="screen" align="right"><table width="95%" cellpadding="5" cellspacing="1" border="0" class="preoutline"><tr class="preinline"><td> <pre class="screen">spdadd 172.16.2.0/24 172.16.1.0/24 any -P fwd ipsec
esp/tunnel/192.168.2.100-192.168.1.100/require;</pre> </td></tr></table></div>
	</p><p>Bu örnekte sadece ESP protokolü kullanýlmýþtýr. ESP protokolü bütünlüðü ve gizliliði garanti eder. Bu durumda ESP algoritmalarýnýn sýrasý önemlidir. Ýlk olarak þifreleme algoritmasýný ve anahtarýný, ardýndan ise kimlik kanýtlama algoritmasýný ve anahtarýný tanýmlamanýz gereklidir.</p><p>Tünelin iki tarafýna da bu dosyayý kopyalamanýz ve politikalarýn yönünü (<b><tt>in</tt></b> yerine <b><tt>out</tt></b>) deðiþtirmeniz gerekir. Yönlendirme politikanýz da varsa IP adreslerinin yönlerini de ters çevirmeniz gerekir.</p><p>BSD IPsec gerleþtirimine benzemeyen bir þekilde Linux'daki bir güvenlik anlaþmasý tünel ve taþýma mýdlarýndan sadece biri için kullanýlabilir. Taþýma modu öntanýmlý mod olduðundan tünel moduna ihtiyaç duyulduðunda güvenlik anlaþmasý <b><tt>-m tunnel</tt></b> ile tanýmlanmalýdýr.</p><p>Artýk güvenlik politikalarý korunacak aðlarýn IP adreslerini göstermektedir. Bu adreslerini kaynak ve hedef olarak kullanacak paketler IPsec tarafýndan korunacaktýr. Tünel modu kullanýldýðýnda güvenlik politikasý güvenliði gerçekleþtirecek taraflarýn IP adreslerini ve tüneli belirtmelidir. Bu bilgileruygun IPsecSA'yý bulmak için gereklidir.</p><p>Tüneliniz çalýþmadýðýnda yönlendirmenizi kontrol etmelisiniz. Ýstemcileriniz diðer aða gönderecekleri paketleri vpn að geçidine göndermeleri gerektiðini bilmelidir. Bunun en kolay çözümü vpn að geçidini öntanýmlý að geçidi yapmaktýr.</p></dd></div></dl></dd></div></dl><dl><div class="sect2"><dt><div> <h3 class="title"><a name="ipsec-howto-kametools-racoon"></a>racoon kullanan otomatik anahtarlamalý baðlantýlar</h3></div></dt><dd><p>KAME IKE altalan süre <b><tt>racoon</tt></b> Linux'a da uyarlanmýþtýr. Bu süreç otomatik anahtarlamalý IPsec baðlantýlarý kurabilmektedir. Racoon kimlik denetiminde önceden paylaþýlan anahtarlarýn, X.509 sertifikalarýn ve Kerberos'un kullanýmýný desteklemektedir. Temel, saldýrgan ve asýl modlarda kullanýlabilir. Bu bölümde <b><tt>racoon</tt></b> yapýlandýrmasý önceden paylaþýlan anahtar ve X.509 sertifikasýyla nasýl yapýldýðý gösterilecektir (Kerberos ile ilgili bölümü yazmayý planlýyorum). Bölüm sonunda bir roadwarrior yapýlandýrma senaryosu özet olarak verilecektir. <div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0"><tr><td rowspan="2" align="center" valign="top" width="25"><img src="../images/xsl/note.png"></td><th>Not</th></tr><tr><td colspan="2" align="left" valign="top"><p>Eðer Linux 2.6.10 (ya da daðýtýmýnýz tarafýndan yamalanmýþ 2.6.9 çekirdeði kullanýyorsanýz ipsec-tools'un 0.5 sürümüne ihtiyacýnýz vardýr.</p></td></tr></table></div></p><dl><div class="sect3"><dt><div> <h4 class="title"><a name="ipsec-howto-kametools-racoon-keys"></a>Önceden paylaþýlmýþ anahtarlar</h4></div></dt><dd><p><b><tt>racoon</tt></b> kullanarak kimlik denetimi yapmanýn en kolay yolu önceden paylaþýlmýþ anahtarlarý kullanmaktýr. Bu anahtarlar <tt>/etc/psk.txt</tt> dosyasýnda belirtilmelidir. Yetkisi olmayan kullanýcýlarýn okuyamamalarý gereken bu dosya (<b><tt>chmod 400 /etc/psk.txt</tt></b> aþaðýdakine benzer olmalýdýr:<div class="screen" align="right"><table width="95%" cellpadding="5" cellspacing="1" border="0" class="preoutline"><tr class="preinline"><td> <pre class="screen"># IPv4 Adresi
192.168.2.100          simple psk
5.0.0.1                0xe10bd52b0529b54aac97db63462850f3
# USER_FQDN
ralf@spenneberg.net    This is a psk for an email address
# FQDN
www.spenneberg.net     This is a psk</pre> </td></tr></table></div>
		</p><p>Bu dosya sütunlar halinde organize edilmiþtir. Ýlk sütun önceden paylaþýlan anahtar (PSK) ile kimlik knaýtlamasý yapýlmýþ olan tarafýn kimliðini barýndýrýr. Ýkinci sütündaki herþey PSK'dýr.</p><p><b><tt>racoon</tt></b> yapýlandýrmasý dosyadan kolaylýkla anlaþýlabilir. Aþaðýdaki sýradan bir <b><tt>racoon</tt></b> yapýlandýrma dosyasý <tt>/etc/racoon.conf</tt> bulacaksýnýz:<div class="screen" align="right"><table width="95%" cellpadding="5" cellspacing="1" border="0" class="preoutline"><tr class="preinline"><td> <pre class="screen">path pre_shared_key "/etc/psk.txt";

remote 192.168.2.100 {
	exchange_mode main;
	proposal {
		encryption_algorithm 3des;
		hash_algorithm md5;
		authentication_method pre_shared_key;
		dh_group modp1024;
		}
}

sainfo address 172.16.1.0/24 any address 172.16.2.0/24 any {
	pfs_group modp768;
	encryption_algorithm 3des;
	authentication_algorithm hmac_md5;
	compression_algorithm deflate;
}</pre> </td></tr></table></div></p><p>
		This configuration file first defines where racoon may find the preshared keys. It then defines a peer 192.168.2.100 and the parameters to use for the phase one of the IKE negotiation. The second paragraph specifies the parameters which may be used for the setup of the security associations. This definition may be specific for defined IP addresses or general using anonymous instead of the IP addresses. Here the encryption, authentication and compression algorithms to use for the SA are defined. All three need to be defined to avoid an error during the startup of racoon.</p><p>The IKE daemon racoon does not start the tunnel negotiation immediately when started. Rather racoon waits until the tunnel is needed. For this notification to occur the kernel needs to know when to notify racoon. To achieve this, the administrator needs to define security policies without the appropiate security associations. Whenever the Linux kernel needs to protect a packet according to the security policies and when no security association is available, the Linux kernel calls racoon and asks for the required security associations. Racoon will then start the IKE negotiations and will create the SAs when finished. The Linux kernel can then send the packets.</p><p>For the assumed setup the following policies are needed on 192.168.1.100: <div class="screen" align="right"><table width="95%" cellpadding="5" cellspacing="1" border="0" class="preoutline"><tr class="preinline"><td> <pre class="screen">#!/usr/sbin/setkey -f
#
# Flush SAD and SPD
flush;
spdflush;

# Create policies for racoon
spdadd 172.16.1.0/24 172.16.2.0/24 any -P out ipsec
esp/tunnel/192.168.1.100-192.168.2.100/require;

spdadd 172.16.2.0/24 172.16.1.0/24 any -P in ipsec
esp/tunnel/192.168.2.100-192.168.1.100/require;</pre> </td></tr></table></div></p><p>Once the policies are loaded using setkey -f /etc/setkey.conf racoon may be started. For testing purposes racoon should be started using racoon -F -f /etc/racoon.conf. Again the configuration of the other peer has to be modified to reflect the different direction. The IP addresses in the files /etc/psk.txt, /etc/setkey.conf and /etc/racoon.conf must be exchanged.</p><p>The initiation of the tunnel can then be followed in the logs:
		
		<div class="screen" align="right"><table width="95%" cellpadding="5" cellspacing="1" border="0" class="preoutline"><tr class="preinline"><td> <pre class="screen">2003-02-21 18:11:17: INFO: main.c:170:main(): @(#)racoon 20001216 20001216
 sakane@kame.net
2003-02-21 18:11:17: INFO: main.c:171:main(): @(#)This product linked Open
SSL 0.9.6b [engine] 9 Jul 2001 (http://www.openssl.org/)
2003-02-21 18:11:17: INFO: isakmp.c:1365:isakmp_open(): 127.0.0.1[500] use
 d as isakmp port (fd=7)
2003-02-21 18:11:17: INFO: isakmp.c:1365:isakmp_open(): 192.168.1.100[500]
 used as isakmp port (fd=9)
2003-02-21 18:11:37: INFO: isakmp.c:1689:isakmp_post_acquire(): IPsec-SA r
equest for 192.168.2.100 queued due to no phase1 found.
2003-02-21 18:11:37: INFO: isakmp.c:794:isakmp_ph1begin_i(): initiate new 
phase 1 negotiation: 192.168.1.100[500]&lt;=&gt;192.168.2.100[500]
2003-02-21 18:11:37: INFO: isakmp.c:799:isakmp_ph1begin_i(): begin Identit
y Protection mode.
2003-02-21 18:11:37: INFO: vendorid.c:128:check_vendorid(): received Vendor
 ID: KAME/racoon
2003-02-21 18:11:37: INFO: vendorid.c:128:check_vendorid(): received Vendor
 ID: KAME/racoon
2003-02-21 18:11:38: INFO: isakmp.c:2417:log_ph1established(): ISAKMP-SA es
tablished 192.168.1.100[500]-192.168.2.100[500] spi:6a01ea039be7bac2:bd288f
f60eed54d0
2003-02-21 18:11:39: INFO: isakmp.c:938:isakmp_ph2begin_i(): initiate new p
hase 2 negotiation: 192.168.1.100[0]&lt;=&gt;192.168.2.100[0]
2003-02-21 18:11:39: INFO: pfkey.c:1106:pk_recvupdate(): IPsec-SA establish
ed: ESP/Tunnel 192.168.2.100-&gt;192.168.1.100 spi=68291959(0x4120d77)
2003-02-21 18:11:39: INFO: pfkey.c:1318:pk_recvadd(): IPsec-SA established:
 ESP/Tunnel 192.168.1.100-&gt;192.168.2.100 spi=223693870(0xd554c2e)</pre> </td></tr></table></div></p></dd></div></dl><dl><div class="sect3"><dt><div> <h4 class="title"><a name="ipsec-howto-kametools-racoon-x509"></a>X.509 Sertifikalarý</h4></div></dt><dd><p>Racoon supports the usage of X.509 certificates for the authentication process. These certificates may be checked against a certificate authority (CA). The configuration is similar to the PSK configuration and differs only on the authentication part:<div class="screen" align="right"><table width="95%" cellpadding="5" cellspacing="1" border="0" class="preoutline"><tr class="preinline"><td> <pre class="screen">path certificate "/etc/certs";

remote 192.168.2.100 {
	exchange_mode main;
	certificate_type x509 "my_certificate.pem" "my_private_key.pem";
	verify_cert on;
	my_identifier asn1dn;
	peers_identifier asn1dn;
	proposal {
		encryption_algorithm 3des;
		hash_algorithm md5;
		authentication_method rsasig;
		dh_group modp1024;
	}
}
					
sainfo address 172.16.1.0/24 any address 172.16.2.0/24 any {
	pfs_group modp768;
	encryption_algorithm 3des;
	authentication_algorithm hmac_md5;
	compression_algorithm deflate;
}</pre> </td></tr></table></div></p><p>The certificate and the private key are stored in the certificate path /etc/certs. This path is set using the option path certificate in the configuration file. The certificates and the certificate revocation lists are stored in PEM format as generated with openssl. For the generation of certificates see the chapter on X.509 certificates. If the certificate of the peer is to be checked against a certificate authority (verify_cert on; is the default), then the certificate of the CA has to be also stored in this directory. For OpenSSL to find the certificate it has to be renamed or linked using the hashed name:
		<div class="screen" align="right"><table width="95%" cellpadding="5" cellspacing="1" border="0" class="preoutline"><tr class="preinline"><td> <pre class="screen">ln -s CAfile.pem `openssl x509 -noout -hash &lt; CAfile.pem`.0</pre> </td></tr></table></div></p><p>If the certificate additionally is to be checked against a certificate revocation file (CRL) the CRL must be stored in the same directory using a similar linked hashed name:
		<div class="screen" align="right"><table width="95%" cellpadding="5" cellspacing="1" border="0" class="preoutline"><tr class="preinline"><td> <pre class="screen">ln -s CRLfile.pem `openssl x509 -noout -hash &lt; CAfile.pem`.r0</pre> </td></tr></table></div></p><p>When storing the certificates and the private key it is important to note that racoon cannot decrypt a private key. Therefore the private key must be stored in its decrypted cleartext form. If you created a crypted private key, you have to decrypt it:
			
			<div class="screen" align="right"><table width="95%" cellpadding="5" cellspacing="1" border="0" class="preoutline"><tr class="preinline"><td> <pre class="screen"># openssl rsa -in my_private_key.pem -out my_private_key.pem
read RSA key
Enter PEM pass phrase: password
writing RSA key</pre> </td></tr></table></div>
		</p></dd></div></dl><dl><div class="sect3"><dt><div> <h4 class="title"><a name="ipsec-howto-kametools-racoon-roadwarrior"></a>Roadwarrior</h4></div></dt><dd><p>Roadwarriors are clients using unknown dynamic IP addresses to connect to a VPN gateway. In combination with racoon this poses two problems:<div class="itemizedlist"><ul type="disc"><li>
				
				The IP address is not known and cannot be specified in the racoon configuration file or in the /etc/psk.txt file. A different way to determine the identity of the client must be found. When using pre-shared keys this requires the aggressive mode! The best solution is the usage of X.509 certificates though.</li><li>
				
      No security policy can be created for racoon to act on, since the destination IP address is not known. racoon must create the security policy and the security association when the connection is initiated.</li></ul></div>
</p><p>To achieve this the configuration file /etc/racoon.conf needs several modifications:
	
	<div class="screen" align="right"><table width="95%" cellpadding="5" cellspacing="1" border="0" class="preoutline"><tr class="preinline"><td> <pre class="screen">path certificate "/etc/certs";
	
remote anonymous {
	exchange_mode main;
	generate_policy on;
	passive on;
	certificate_type x509 "my_certificate.pem" "my_private_key.pem";
	my_identifier asn1dn;
	peers_identifier asn1dn;
	proposal {
	encryption_algorithm 3des;
	hash_algorithm md5;
	authentication_method rsasig;
	dh_group modp1024;
	}
}
	
	
sainfo anonymous {
	pfs_group modp1024;
	encryption_algorithm 3des;
	authentication_algorithm hmac_md5;
	compression_algorithm deflate;
}</pre> </td></tr></table></div>
</p><p>The option generate_policy on instructs racoon to create the appropriate policy when a new connection is initiated. The option passive on tells racoon to remain passive and wait for new connection to be started from the outside. racoon may not start a connection.</p><p>The most important change though is the definition of anonymous in the remote and sainfo line. This instructs racoon to accept the connection from anywhere.</p></dd></div></dl></dd></div></dl><dl><div class="sect2"><dt><div> <h3 class="title"><a name="ipsec-howto-kametools-nattraversal"></a>Aykýrý NAT</h3></div></dt><dd><p>The Linux kernel 2.6 is capable of using NAT traversal in tunnel mode. Transport mode is not supported yet. This can be used by Racoon starting with version 0.3.3 of the ipsec-tools.</p><p>To configure Racoon for NAT traversal several options have been added to the configuration file. These are natt_keepalive, isakmp_natt, nat_traversal.</p><p>The most important option is nat_traversal. This can be set to on, off or force. When set to on this peer will use NAT traversal as soon as a NAT device is detected on the path. Off will disable this behavior. When using force NAT traversal will be used regardless wether a NAT device is found or not.</p><p>Since many NAT devices forget the entries in their internal tables quite fast when no traffic is seen, racoon offers to send keepalive packets across the wire. These are send every 20 seconds by default. You can change this value using natt_keepalive. Setting this to 0 seconds will disable this feature.</p><p>If you want to use NAT traversal you have to specify the IP address and the port to use in the listen section of the racoon configuration file. This is done using isakmp_natt.</p><p>For clarity a typical configuration file is shown, where the peer 192.168.2.100 is hidden by a NAT gateway with the IP address 192.168.1.1:
			
			<div class="screen" align="right"><table width="95%" cellpadding="5" cellspacing="1" border="0" class="preoutline"><tr class="preinline"><td> <pre class="screen">path pre_shared_key "/etc/psk.txt";
			
timer  {
	natt_keepalive 10sec;
	}

listen {
	isakmp 192.168.1.100 [500];
	isakmp_natt 192.168.1.100 [4500];
}
			
remote 192.168.1.1 {
	exchange_mode main;
	nat_traversal on;
	proposal {
		encryption_algorithm 3des;
		hash_algorithm md5;
		authentication_method pre_shared_key;
		dh_group modp1024;
	}
}
			
sainfo address 172.16.1.0/24 any address 172.16.2.0/24 any {
	pfs_group modp768;
	encryption_algorithm 3des;
	authentication_algorithm hmac_md5;
	compression_algorithm deflate;
}</pre> </td></tr></table></div>
</p><p>If you configured everything correctly NAT will be detected automatically:
	
	<div class="screen" align="right"><table width="95%" cellpadding="5" cellspacing="1" border="0" class="preoutline"><tr class="preinline"><td> <pre class="screen">2004-12-22 07:34:53: INFO: @(#)ipsec-tools 0.4 (http://ipsec-tools.sourceforge.net)
2004-12-22 07:34:53: INFO: @(#)This product linked OpenSSL 0.9.7a Feb 19 2003 (http://www.openssl.org/)
2004-12-22 07:34:53: INFO: 192.168.1.100[4500] used as isakmp port (fd=6)
2004-12-22 07:34:53: INFO: 192.168.1.100[4500] used for NAT-T
2004-12-22 07:34:53: INFO: 192.168.1.100[500] used as isakmp port (fd=7)
2004-12-22 07:35:09: INFO: respond new phase 1 negotiation: 192.168.1.100[500]&lt;-&gt;192.168.1.1[500]
2004-12-22 07:35:09: INFO: begin Identity Protection mode.
2004-12-22 07:35:09: INFO: received Vendor ID: draft-ietf-ipsec-nat-t-ike-02
2004-12-22 07:35:09: INFO: received Vendor ID: RFC XXXX
2004-12-22 07:35:09: INFO: Selected NAT-T version: RFC XXXX
2004-12-22 07:35:09: INFO: Hashing 192.168.1.100[500] with algo #1 
2004-12-22 07:35:09: INFO: NAT-D payload #0 verified
2004-12-22 07:35:09: INFO: Hashing 192.168.1.1[500] with algo #1 
2004-12-22 07:35:09: INFO: NAT-D payload #1 doesn't match
2004-12-22 07:35:09: INFO: NAT detected: PEER
2004-12-22 07:35:10: INFO: Hashing 192.168.1.1[500] with algo #1 
2004-12-22 07:35:10: INFO: Hashing 192.168.1.100[500] with algo #1 
2004-12-22 07:35:10: INFO: Adding remote and local NAT-D payloads.
2004-12-22 07:35:10: INFO: NAT-T: ports changed to: 192.168.1.1[4500]&lt;-&gt;192.168.1.100[4500]
2004-12-22 07:35:10: INFO: KA list add: 192.168.1.100[4500]-&gt;192.168.1.1[4500]
2004-12-22 07:35:10: INFO: ISAKMP-SA established 192.168.1.100[4500]-192.168.1.1[4500] spi:0613dc09c4ccc828:9cc9dfc9acc82eb5
2004-12-22 07:35:11: INFO: respond new phase 2 negotiation: 192.168.1.100[0]&lt;-&gt;192.168.1.1[0]
2004-12-22 07:35:11: INFO: Adjusting my encmode UDP-Tunnel-&gt;Tunnel
2004-12-22 07:35:11: INFO: Adjusting peer's encmode UDP-Tunnel(3)-&gt;Tunnel(1)
2004-12-22 07:35:11: INFO: IPsec-SA established: ESP/Tunnel 192.168.1.1-&gt;192.168.1.100 spi=95762109(0x5b536bd)
2004-12-22 07:35:11: INFO: IPsec-SA established: ESP/Tunnel 192.168.1.100-&gt;192.168.1.1 spi=222871470(0xd48bfae)</pre> </td></tr></table></div>
			</p><p>When looking at the packets on the wire you will see UDP traffic traversing back and forth:
				
<div class="screen" align="right"><table width="95%" cellpadding="5" cellspacing="1" border="0" class="preoutline"><tr class="preinline"><td> <pre class="screen">[root@bibo root]# tcpdump
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on tap1, link-type EN10MB (Ethernet), capture size 96 bytes
13:37:41.920621 IP 192.168.1.1.isakmp &gt; 192.168.1.100.isakmp: isakmp: phase 1 I ident
13:37:41.941296 IP 192.168.1.100.isakmp &gt; 192.168.1.1.isakmp: isakmp: phase 1 R ident
13:37:42.051826 IP 192.168.1.1.isakmp &gt; 192.168.1.100.isakmp: isakmp: phase 1 I ident
13:37:42.157134 IP 192.168.1.100.isakmp &gt; 192.168.1.1.isakmp: isakmp: phase 1 R ident
13:37:42.353942 IP 192.168.1.1.4500 &gt; 192.168.1.100.4500: UDP, length 72
13:37:42.361530 IP 192.168.1.100.4500 &gt; 192.168.1.1.4500: UDP, length 72
13:37:42.373799 IP 192.168.1.1.4500 &gt; 192.168.1.100.4500: UDP, length 88
13:37:43.374630 IP 192.168.1.100.4500 &gt; 192.168.1.1.4500: UDP, length 1
13:37:43.384476 IP 192.168.1.1.4500 &gt; 192.168.1.100.4500: UDP, length 256
13:37:43.431219 IP 192.168.1.100.4500 &gt; 192.168.1.1.4500: UDP, length 256
13:37:43.436680 IP 192.168.1.1.4500 &gt; 192.168.1.100.4500: UDP, length 56
13:37:44.492976 IP 192.168.1.1.4500 &gt; 192.168.1.100.4500: UDP, length 1
13:37:45.390137 IP 192.168.1.1.4500 &gt; 192.168.1.100.4500: UDP, length 116
13:37:45.390612 IP 192.168.1.100.4500 &gt; 192.168.1.1.4500: UDP, length 116
13:37:46.395603 IP 192.168.1.1.4500 &gt; 192.168.1.100.4500: UDP, length 116
13:37:46.396009 IP 192.168.1.100.4500 &gt; 192.168.1.1.4500: UDP, length 116</pre> </td></tr></table></div>
			</p><p>If you are using your Racoon not in a roadwarrior setup but with fixed addresses as above you need to modify your Security Policies too. These need to reflect the natted addresses! The correct Policies for the above scenario are:
				
<div class="screen" align="right"><table width="95%" cellpadding="5" cellspacing="1" border="0" class="preoutline"><tr class="preinline"><td> <pre class="screen">#!/usr/sbin/setkey -f
#
# Flush SAD and SPD
flush;
spdflush;

# Create policies for racoon
spdadd 172.16.1.0/24 172.16.2.0/24 any -P out ipsec
esp/tunnel/192.168.1.100-192.168.1.1/require;

spdadd 172.16.2.0/24 172.16.1.0/24 any -P in ipsec
esp/tunnel/192.168.1.1-192.168.1.100/require;</pre> </td></tr></table></div></p><p>These policies are automatically setup if you use generate_policy on; in your Racoon configuration.</p></dd></div></dl></dd></div></dl><h1></h1><table width="100%" summary="Navigation header" cellpadding="1" cellspacing="0" border="0"><tr><td bgcolor="black" class="navoutline"><table width="100%" cellpadding="0" cellspacing="0" border="0"><tr><td bgcolor="white" class="navinline"><table width="100%" cellpadding="3" cellspacing="0" border="0"><tr><td width="40%" align="left"><a accesskey="p" href="../howto/ipsec-howto-openswan.html">Önceki</a> </td><td width="20%" align="center"><a accesskey="u" href="../howto/ipsec-howto.html">Üst Ana Baþlýk</a></td><td width="40%" align="right"> <a accesskey="n" href="../howto/ipsec-howto-isakmpd.html">Sonraki</a></td></tr><tr><td width="40%" align="left" valign="top">Linux 2.6 Üzerinde Çalýþan Openswan </td><td width="20%" align="center"><a accesskey="h" href="../KiTAPLIK/index.html">Baþlangýç</a></td><td width="40%" align="right" valign="top"> OpenBSD'nin isakmpd aracýný kullanýlan Linux 2.6 Çekirdeði</td></tr><tr><td colspan="3" align="center">
                  Bir <a href="http://www.belgeler.org/">Linux Kitaplýðý</a> Sayfasý
                </td></tr></table></td></tr></table></td></tr></table></body></html>
