<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-9"><meta name="date" content="2008-10-18T00:53:20+03:00"><title>OpenBSD'nin isakmpd aracýný kullanýlan Linux 2.6 Çekirdeði</title><link rel="icon" type="image/png" href="../images/belgeler-logo.png"><link rel="stylesheet" href="../belgeler.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V-special(derived from 1.49 for Turkish Linux Documentation WG by Nilgün Belma Bugüner - nilgun@superonline.com)"><link rel="home" href="../KiTAPLIK/index.html" title="Linux Kitaplýðý"><link rel="up" href="../howto/ipsec-howto.html" title="IPsec NASIL"><link rel="previous" href="../howto/ipsec-howto-kametools.html" title="KAME-tools kullanan Linux 2.6 Çekirdeði"><link rel="next" href="../howto/ipsec-howto-x509.html" title="X.509 Sertifikalarý Oluþturmak"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><table width="100%" summary="Navigation header" cellpadding="1" cellspacing="0" border="0"><tr><td bgcolor="black" class="navoutline"><table width="100%" cellpadding="0" cellspacing="0" border="0"><tr><td bgcolor="white" class="navinline"><table width="100%" cellpadding="3" cellspacing="0" border="0"><tr><th colspan="3" align="center">OpenBSD'nin isakmpd aracýný kullanýlan Linux 2.6 Çekirdeði</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="../howto/ipsec-howto-kametools.html">Önceki</a> </td><th width="60%" align="center">IPsec NASIL</th><td width="20%" align="right"> <a accesskey="n" href="../howto/ipsec-howto-x509.html">Sonraki</a></td></tr></table></td></tr></table></td></tr></table><dl><div class="sect1"><dt><div> <h2 class="title" style="clear: both"><a name="ipsec-howto-isakmpd"></a>OpenBSD'nin isakmpd aracýný kullanýlan Linux 2.6 Çekirdeði</h2></div></dt><dd><p>Thomas Walpuski OpenBSD iþletim sisteminin IKE artalan sürecini Linux'ta kullanýlabilir hale getirmiþtir (<a href="http://bender.thinknerd.de/~thomas/IPsec/isakmpd-linux.html" target="_top">http://bender.thinknerd.de/~thomas/IPsec/isakmpd-linux.html</a>). Artýk <b><tt>isakmpd</tt></b> Linux çekirdeði 2.5.47+ ve 2.6.x sürümlerinde IPsec VPN oluþturmak için kullanýlabilmektedir. Bu bölümde <b><tt>isakmpd</tt></b> kurulum ve yapýlandýrmasý anlatýlacaktýr.</p><dl><div class="sect2"><dt><div> <h3 class="title"><a name="ipsec-howto-isakmpd-installation"></a>Kurulum</h3></div></dt><dd><p>Eðer RPM tabanlý bir datýðým veya Debian kullanýyorsanýz kurulum iþlemi paket yönetim araçlarýyla kolayca yapýlabilir. Bu belgenin yazarý Linux 2.6.0 çekirdeði için bir RPM paketi derlemiþtir (ulink url="http://www.spenneberg.org/VPN/Kernel-2_6_IPsec"/&gt;). Çekirdekteki ABI bir çok kez deðiþtiði için bu paketin deneme sürümlerinde çalýþmayacaðýný þimdiden söylemeliyim. Debian projesi <b><tt>apt-get install isakmpd</tt></b> komutuyla kurulabilecek bir paketi içermektedir.</p><p>Kurulum kaynak koddan yapýlýrken eðer X.509 sertifikalarýný kullanmak istiyorsanýz keynote paketine de ihtiyacýnýz olacaktýr (<a href="http://www1.cs.columbia.edu/~angelos/keynote.html" target="_top">http://www1.cs.columbia.edu/~angelos/keynote.html</a>). Ýlave olarak Linux çekirdek sürümünüz 2.5.47+ veya 2.6.x olmalýdýr.</p><p>isakmpd kaynak koduna ulaþmak için Thomas Walpuski'nin sayfasýndaki yönergeleri takip etmelisiniz. Dosyayý indirdikten sonra <tt>GNUmakefile</tt> dosyasýný düzenleyerek <b><tt>OS=linux</tt></b> satýrýný aktif hale getirin. Eðer çekirdek kaynak kodunu <tt>/usr/src/linux</tt> dizininden farklý bir yerde bulunduruyorsanýz bunu <tt>sysdep/linux/GNUmakefile.sysdep</tt> dosyasýný düzenleyerek belirtmelisiniz.</p><p>Derleme iþlemi <b><tt>make</tt></b> komutu ile yapýlýr.</p><p><b><tt>isakmpd</tt></b> iki ilave komutla birlikte gelir: <b><tt>keyconv</tt></b> ve <b><tt>certpatch</tt></b>. Bu araçlar <tt>apps</tt> alt dizininde bulunur elle derlenmeleri gerekir (benim hazýrladýðým RPM paketi bu araçlarý da içeriyordu). <b><tt>keyconv</tt></b> DNSSEC  openssl anahtarýna dönüþtürülürken <b><tt>Certpatch</tt></b> ile varolan bir sertifikaya SubjectAltName eklenebilir ya da tersi yapýlabilir.</p><p>Aþaðýdaki komutlar bu araçlarý derlememe yeterlioldu (sizde farklý olabilir):
			
	<div class="screen" align="right"><table width="95%" cellpadding="5" cellspacing="1" border="0" class="preoutline"><tr class="preinline"><td> <pre class="screen">gcc -DMP_FLAVOUR=MP_FLAVOUR_GMP -I../.. -I../../sysdep/linux   -I /usr/src/linux-2.6.0 -lcrypto -lgmp certpatch.c -o certpatch
gcc  -I../.. -I../../sysdep/linux   -I /usr/src/linux-2.6.0 -lcrypto -lgmp base64.c keyconv.c -o keyconv</pre> </td></tr></table></div></p><p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0"><tr><td rowspan="2" align="center" valign="top" width="25"><img src="../images/xsl/warning.png"></td><th>Uyarý</th></tr><tr><td colspan="2" align="left" valign="top"> Tüm man sayfalarý Latin1 biçemindedir. Red Hat 9 bu dosyalarý gösterememektedir.<sup>[<a name="id1" href="#ftn.id1">14</a>]</sup> Görüntüleyebilmek için dönüþtürülmeleri gereklidir: <b><tt>iconv --from-code LATIN1 --to-code UTF-8 --output isakmpd2.8 isakmpd.8</tt></b></td></tr></table></div></p><p><b><tt>isakmpd</tt></b> derlendiðinde zorunlu olan dizin yapýsýný oluþturur:
<div class="screen" align="right"><table width="95%" cellpadding="5" cellspacing="1" border="0" class="preoutline"><tr class="preinline"><td> <pre class="screen">mkdir /etc/isakmpd
mkdir /etc/isakmpd/ca
mkdir /etc/isakmpd/certs
mkdir /etc/isakmpd/keynote
mkdir /etc/isakmpd/crls
mkdir /etc/isakmpd/private
mkdir /etc/isakmpd/pubkeys</pre> </td></tr></table></div>
      </p></dd></div></dl><dl><div class="sect2"><dt><div> <h3 class="title"><a name="ipsec-howto-isakmpd-psk"></a>Önceden Paylaþýlan Anahtarlarý (PSK) Kullanmak</h3></div></dt><dd><p><b><tt>isakmpd</tt></b> bir yapýlandýrma dosyasý (<tt>/etc/isakmpd/isakmpd.conf</tt>), bir de politika dosyasý <tt>/etc/isakmpd/isakmpd.policy</tt> kullanýr. Yapýlandýrma iyi bilinen .INI sitilini kullanýr. Her bir bölüm aþaðýdaki gibi bir satýrla baþlar:<div class="screen" align="right"><table width="95%" cellpadding="5" cellspacing="1" border="0" class="preoutline"><tr class="preinline"><td> <pre class="screen">[section]</pre> </td></tr></table></div>
		</p><p>Her bölümün içinde bir deðiþkene deðer atayabilirsiniz:<div class="screen" align="right"><table width="95%" cellpadding="5" cellspacing="1" border="0" class="preoutline"><tr class="preinline"><td> <pre class="screen">tag=value</pre> </td></tr></table></div></p><p>Eðer deðer bir satýrdan uzunsa \ iþareti ile birden fazla satýr kullanabilirsiniz. Yorum satýrlarý # ile baþlar.</p><p>Baþlangýçta kimlik kanýtlama için önceden paylaþýlmýþ anahtarýn kullanýldýðý baist bit yapýlandýrmaya bakacaðýz. Kurulum için <a href="../howto/ipsec-howto-kametools.html#ipsec-howto-tunel" title="Þekil 5.12. Ýki að arasýndaki trafiði koruyan iki bilgisayar">Þekil 5.12</a>'e bakabilirsiniz.
<div class="screen" align="right"><table width="95%" cellpadding="5" cellspacing="1" border="0" class="preoutline"><tr class="preinline"><td> <pre class="screen">[General]
Listen-on=              192.168.1.100

[Phase 1]
192.168.2.100=                ISAKMP-peer-west

[Phase 2]
Connections=            IPsec-east-west

[ISAKMP-peer-west]
Phase=                  1
Local-address=          192.168.1.100
Address=                192.168.2.100
Authentication=         ThisIsThePassphrase

[IPsec-east-west]
Phase=                  2
ISAKMP-peer=            ISAKMP-peer-west
Configuration=          Default-quick-mode
Local-ID=               Net-east
Remote-ID=              Net-west

[Net-west]
ID-type=                IPV4_ADDR_SUBNET
Network=                172.16.2.0
Netmask=                255.255.255.0

[Net-east]
ID-type=                IPV4_ADDR_SUBNET
Network=                172.16.1.0
Netmask=                255.255.255.0

[Default-quick-mode]
DOI=                    IPSEC
EXCHANGE_TYPE=          QUICK_MODE
Suites=                 QM-ESP-3DES-MD5-PFS-SUITE</pre> </td></tr></table></div>
      </p><p>Bu yapýlandýrma 192.168.1.100 ve 192.168.2.100 adreslerine sahip iki að geçidi arasýnda bir tünel oluþturur. Bu tünel 172.16.1.0/24 ve 172.16.2.0/24 aðlarý tarafýndan kullanýlabilir. Yukarýdaki dosya 192.168.1.100 IP adresine sahip að geçidinin kullanacaðý dosyadýr.</p><p>Þimdi her bölümü ayrýntýlý olarak inceleyelim. Ýlk bölüm [General] genel kurulumu belirler. Burada kurulum aþamasýnda isakmpd'nin belirli bir IP adresine baðlanmasý gerekip gerekmediðini belirtiyoruz. Eðer VPN aðgeçicidinizin birden çok IP adresi varsa bunu yapmanýz tavsiye edilir.</p><p>[Phase 1] bölümü 192.168.2.100 adresli taraf için hangi yapýlandýrmanýn kullanýlacaðýný tanýmlar. Eðer karþý tarafýn IP adresi belli deðilse (roadwarrior) bunun yerine öntanýmlý deðeri kullanabilirsiniz.</p><p>[Phase 2] bölümü ise Phase 1 kimlik kanýtlamasý yapýldýktan sonra oluþturulacak tüneli tanýmlanýr. Eðer isakmpd baðlantýlarý aktif olarak baþlatmýyorsa bunun yerine <b><tt>Passive-connections</tt></b> kullanýlabilir.</p><p>Bu aþamada Phase 1 ve Phase 2 bölümlerine karþýlýk gelecek bir isim verilmelidir. Bu örnekte ISAKMP-peer-west ismini kullandýk. Bu tanýmlama Phase 1'de kullanýldýðýndan yerel ve uzak adresleri biliyoruz. Eðer uzak adres biinmiyorsa bu satýrý kaldýrmak yeterlidir. Kimlik kanýtlama düz metin olarak verilen önceden paylaþýlan anahtarla yapýlmalýdýr.</p><p>Sýradaki tanýmlama IPsec-east-west tünelinin tanýmlamasýdýr. Bu tünel Phase 2'de kullanýlmýþtýr ve ISAKMP-peer tarafýndan ISAKMP-peer-west tüneline baðlanýlýrken kullanýlmalýdýr. Baðlantýnýn yapýlandýrmasýný ve tüneli diðer tanýmlamalarý da (Local-ID ve Remote-ID) burada yapýlmalýdýr.</p><p>Bu tanýmlanacak <b><tt>ID-type</tt></b> þunlar olabilir: IPV4_ADDR, IPV6_ADDR, IPV4_ADDR_SUBNET ve IPV6_ADDR_SUBNET.</p><p>Son olarak quick-mode yapýlandýrmasý bölümü bulunmaktadýr. Bu bölümde tünel tanýmlama bilgileri bulunmaktadýr. Bu bilgiler <b><tt>DOI</tt></b> (öntanýmlý deðeri: IPSEC), <b><tt>EXCHANGE_TYPE</tt></b> (öntanýmlý deðeri: QUICK_MODE) ve <b><tt>Suites</tt></b>. Yukarýdaki QM-ESP-3DES-MD5-PFS-SUITE deðerinin açýlýmý QuickMode-Encapsulated-Security-Payload-3DES-Encryption-MD5-HMAC-Perfect-Forward-Secrecy'dir. birden çok deðer verilecekse bunlar birbirinden virgülle ayrýlmalýdýr. Man dosyasýnda mümkün olan bütün taþýmalar ve takýmlar bulunmaktadýr.</p><p><tt>isakmpd.policy</tt> daha kýsa bir dosyadýr. Aþaðýda bir örneði bulunmaktadýr:	      
<div class="screen" align="right"><table width="95%" cellpadding="5" cellspacing="1" border="0" class="preoutline"><tr class="preinline"><td> <pre class="screen">KeyNote-Version: 2
Authorizer: "POLICY"
Licensees: "passphrase:ThisIsThePassphrase"
Conditions: app_domain == "IPsec policy" &amp;&amp;
esp_present == "yes" &amp;&amp;
esp_enc_alg == "3des" &amp;&amp;
esp_auth_alg == "hmac-md5" -&gt; "true";</pre> </td></tr></table></div>
      </p><p>Baðlantýyý denemek için <b><tt>isakmpd</tt></b> aþaðýdaki gibi baþlatýlýr:
	      <div class="screen" align="right"><table width="95%" cellpadding="5" cellspacing="1" border="0" class="preoutline"><tr class="preinline"><td> <pre class="screen">isakmpd -d -4 -DA=90</pre> </td></tr></table></div>
      </p><p>Bu komutla <b><tt>isakmpd</tt></b>, önalanda (<b><tt>-d</tt></b>) IPv4 (<b><tt>-4</tt></b>) kullanacak þekilde ve hata ayýklama seviyesi 90 (<b><tt>-DA=90</tt></b>) olarak baþlatýlmýþ olur.</p><p>Baðlantý kurulduðunda bir aðdan diðerine ping paketleri gönderebiliyor olmanýz gerekir. Eðer <b><tt>ipsec-tools</tt></b>'u da kurmuþsanýz <b><tt>isakmpd</tt></b> tarafýndan eklenen politikalarý ve güvenlik anlaþmalarýný görüntülemek için <b><tt>setkey</tt></b> komutunu da kullanabilirsiniz. ctrl-c ile önalanda çalýþan <b><tt>isakmpd</tt></b>'yi öldürmeniz SAD ve SPD'yi temizlemez. Bunu ancak <b><tt>setkey</tt></b> komutunu elle çalýþtýrarak yapabilirsiniz. Þayet <b><tt>isakmpd</tt></b>'yi <b><tt>kill -TERM</tt></b> ile öldürülürürseniz SAD ve SPD'yi temizlemiþ olursunuz!</p></dd></div></dl><dl><div class="sect2"><dt><div> <h3 class="title"><a name="ipsec-howto-isakmpd-x509"></a>X.509 Sertifikalarýný Kullanmak</h3></div></dt><dd><p><b><tt>isakmpd</tt></b> kimlik kanýtlama süreçlerinde X.509 sertifikalarýný kullanabilir. Kendi sertifikalarýnýzý her zamanki araçlarla oluþturabilirsiniz. VPN'in her iki tarafý için aþaðýdaki dosyalara ihtiyacýnýz olacak:
		<div class="itemizedlist"><ul type="disc"><li><tt>/etc/isakmpd/private/local.key</tt> Makinenin .pem biçeminde özel anahtarý. Eriþim izinleri 600 olmalýdýr.</li><li><tt>/etc/isakmpd/ca/ca.crt</tt> Güvendiðiniz sertifika otoritesinin sertifikasý.</li><li><tt>/etc/isakmpd/certs/ip-address.crt</tt> Yerel makinenin sertifikasý.</li></ul></div></p><p><b><tt>isakmpd</tt></b>'nin sertifikalarý bulup kullanmasý için bir SubjectAltName içermesi gerekir. Bu X.509v3 geliþletmesi sertifikalarýn oluþturulma sürecinde veya daha sonra <b><tt>certpatch</tt></b> komutu ile tanýmlanabilir. Bu komut CA'nýn özel anahtarýný kullanýr, sertifikayý açar ve eklentiyi ekledikten sonra sertifikayý tekrar imzalar.
	<div class="screen" align="right"><table width="95%" cellpadding="5" cellspacing="1" border="0" class="preoutline"><tr class="preinline"><td> <pre class="screen">certpatch -i ip-address -k ca.key  originalcert.crt newcert.crt</pre> </td></tr></table></div>
	</p><p><b><tt>Certpatch</tt></b> sertifikaya bir IP adresi ekleyebileceði gibi bir FQDN veya bir UFQDN de ekleyebilir.</p><p>Bu dosyalar uygun dizinlere yerleþtirildikten ve gerekli eriþim yetkileri verildikten sonra yapýlandýrma ve politika dosyalarýný oluþturabilirsiniz. Yapýlandýrma dosyasýnda Authentication satýrýný kaldýrýn ve ISAKMP-peer-west bölümüne <b><tt>ID=East</tt></b> satýrýný ekleyin. Ardýndan East'ý tanýmlayýn. Ek olarak X.509 dizinlerini de belirtmeniz gerekecektir. Tam bir yapýlandýrma dosyasý örneði aþaðýda verilmiþtir:
		
		<div class="screen" align="right"><table width="95%" cellpadding="5" cellspacing="1" border="0" class="preoutline"><tr class="preinline"><td> <pre class="screen">[General]
Listen-on=              192.168.1.100

[Phase 1]
192.168.2.100=                ISAKMP-peer-west

[Phase 2]
Connections=            IPsec-east-west

[ISAKMP-peer-west]
Phase=                  1
Local-address=          192.168.1.100
Address=                192.168.2.100
ID=                     East

[East]
ID-type=                IPV4_ADDR
Address=                192.168.1.100

[IPsec-east-west]
Phase=                  2
ISAKMP-peer=            ISAKMP-peer-west
Configuration=          Default-quick-mode
Local-ID=               Net-east
Remote-ID=              Net-west

[Net-west]
ID-type=                IPV4_ADDR_SUBNET
Network=                172.16.1.0
Netmask=                255.255.255.0

[Net-east]
ID-type=                IPV4_ADDR_SUBNET
Network=                172.16..2.0
Netmask=                255.255.255.0

[Default-quick-mode]
DOI=                    IPSEC
EXCHANGE_TYPE=          QUICK_MODE
Suites=                 QM-ESP-3DES-MD5-PFS-SUITE
[X509-certificates]
CA-directory=           /etc/isakmpd/ca/
Cert-directory=         /etc/isakmpd/certs/
Private-key=            /etc/isakmpd/private/local.key</pre> </td></tr></table></div>
      </p><p>Politika dosyasý da düzenlenmeye ihtiyaç duyar. Sadece güvenilen CA tarafýndan imzalanan sertifikalarý kullanan taraflara izin vermek istediðinizden Authorizer satýrýndan sonra gerekli satýrlarý ekleyin. Aþaðýda eksiksiz bir politika dosyasý bulunmaktadýr: 
<div class="screen" align="right"><table width="95%" cellpadding="5" cellspacing="1" border="0" class="preoutline"><tr class="preinline"><td> <pre class="screen">KeyNote-Version: 2
Authorizer: "POLICY"
Licensees: "DN:/C=DE/ST=NRW/L=Steinfurt/O=Spenneberg.Com/OU=VPN/CN=RootCA"
Conditions: app_domain == "IPsec policy" &amp;&amp;
esp_present == "yes" &amp;&amp;
esp_enc_alg == "3des" &amp;&amp;
esp_auth_alg == "hmac-md5" -&gt; "true";</pre> </td></tr></table></div>
      </p><p><b><tt>DN:</tt></b> ifadesini takip eden metin CA sertifikasýnýn konu satýrýyla uyuþmalýdýr:
      <div class="screen" align="right"><table width="95%" cellpadding="5" cellspacing="1" border="0" class="preoutline"><tr class="preinline"><td> <pre class="screen">openssl x509 -in ca/ca.crt -noout -subject</pre> </td></tr></table></div></p><p>Yapýlandýrmayý denemek için her zamanki gibi <b><tt>isakmpd</tt></b>'yi baþlatabilirsiniz.</p></dd></div></dl><div class="footnotes"><br><hr width="100" align="left"><table width="100%" summary="Footnotes" cellspacing="3" cellpading="1" class="footnote"><tr><td bgcolor="white" class="footoutline"><table width="100%" cellpadding="3" cellspacing="0" border="0"><tr><td bgcolor="white" class="footinline"><p><sup>[<a name="ftn.id1" href="#id1">14</a>] </sup>Bu, günü geçmiþ bir iþletim sistemi olduðundan uyarýyý dikkate almanýz gerekmez.</p></td></tr></table></td></tr></table></div></dd></div></dl><h1></h1><table width="100%" summary="Navigation header" cellpadding="1" cellspacing="0" border="0"><tr><td bgcolor="black" class="navoutline"><table width="100%" cellpadding="0" cellspacing="0" border="0"><tr><td bgcolor="white" class="navinline"><table width="100%" cellpadding="3" cellspacing="0" border="0"><tr><td width="40%" align="left"><a accesskey="p" href="../howto/ipsec-howto-kametools.html">Önceki</a> </td><td width="20%" align="center"><a accesskey="u" href="../howto/ipsec-howto.html">Üst Ana Baþlýk</a></td><td width="40%" align="right"> <a accesskey="n" href="../howto/ipsec-howto-x509.html">Sonraki</a></td></tr><tr><td width="40%" align="left" valign="top">KAME-tools kullanan Linux 2.6 Çekirdeði </td><td width="20%" align="center"><a accesskey="h" href="../KiTAPLIK/index.html">Baþlangýç</a></td><td width="40%" align="right" valign="top"> X.509 Sertifikalarý Oluþturmak</td></tr><tr><td colspan="3" align="center">
                  Bir <a href="http://www.belgeler.org/">Linux Kitaplýðý</a> Sayfasý
                </td></tr></table></td></tr></table></td></tr></table></body></html>
