<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-9"><meta name="date" content="2008-10-08T14:01:50+03:00"><title>Teorik Bilgiler</title><link rel="icon" type="image/png" href="../images/belgeler-logo.png"><link rel="stylesheet" href="../belgeler.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V-special(derived from 1.49 for Turkish Linux Documentation WG by Nilgün Belma Bugüner - nilgun@superonline.com)"><link rel="home" href="../KiTAPLIK/index.html" title="Linux Kitaplýðý"><link rel="up" href="../howto/ipsec-howto.html" title="IPsec NASIL"><link rel="previous" href="../howto/ipsec-howto-intro.html" title="Giriþ"><link rel="next" href="../howto/ipsec-howto-openswan.html" title="Linux 2.6 Üzerinde Çalýþan Openswan"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><table width="100%" summary="Navigation header" cellpadding="1" cellspacing="0" border="0"><tr><td bgcolor="black" class="navoutline"><table width="100%" cellpadding="0" cellspacing="0" border="0"><tr><td bgcolor="white" class="navinline"><table width="100%" cellpadding="3" cellspacing="0" border="0"><tr><th colspan="3" align="center">Teorik Bilgiler</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="../howto/ipsec-howto-intro.html">Önceki</a> </td><th width="60%" align="center">IPsec NASIL</th><td width="20%" align="right"> <a accesskey="n" href="../howto/ipsec-howto-openswan.html">Sonraki</a></td></tr></table></td></tr></table></td></tr></table><dl><div class="sect1"><dt><div> <h2 class="title" style="clear: both"><a name="ipsec-howto-theory"></a>Teorik Bilgiler</h2></div></dt><dd><dl><div class="sect2"><dt><div> <h3 class="title"><a name="ipsec-howto-theory-whatis"></a>IPsec Nedir?</h3></div></dt><dd><p>IPsec IP protokolünün IP ve daha üst katmanlar için güvenlik saðlayan bir geniþletmesidir. Ýlk olarak yeni IPv6 standadý için geliþtirilmiþ daha sonra IPv4 için "geriye yapýlandýrýlmýþtýr". IPsec mimarisi RFC2401 belgesinde tanýmlanmýþtýr. Aþaðýdaki bir kaç paragraf IPsec için kýsa bir giriþ olacaktýr.</p><p>IPsec iletiþimin doðruluðunu kanýtlamak, bütünlük ve gizliliðinden emin olmak için iki farklý protokol kullanýr: AH ve ESP. Tüm IP datagramýný koruyabileceði gibi sadece daha üst katmanlarýn protokollerini de koruyabilir. Bu durumlar için karþýlýk gelen modlar tünel ve taþýma modlarýdýr. Tünel modunda IP datagramý IPsec protokolünü kullanarak yeni bir IP datagramý tarafýndan tamamen kapsüllenir. Taþýma modunda ise IP datagramýnýn sadece kullanýcý verisi (payload) IPsec protokolü tarafýndan IPsec baþlýðý IP baþlýðý ile daha üst katman protokol baþlýðý arasýna yerleþtirilerek iþlenir. (<a href="../howto/ipsec-howto-theory.html#ipsec-howto-mods" title="Þekil 4.1. IPsec Tünel ve Trasport Modlarý">Þekil 4.1</a>'e bakýnýz.)</p><p><div class="figure"><p><a name="ipsec-howto-mods"></a><b>Þekil 4.1. IPsec Tünel ve Trasport Modlarý</b></p><div class="mediaobject"><img src="images/ipsec/mods.png" align="center"></div></div>
		</p><p>IPsec protokolleri IP datagramlarýnýn bütünlüðünü korumak için hash mesaj doðrulama kodlarýný (HMAC) kullanýr. MD5 ve SHA gibi hash algoritmalarý kullanarak IP datagramý ve bir gizli anahtarý temel alan HMAC'i çýkartýrlar. Daha sonra bu HMAC IPsec protokol baþlýðýna eklenir ve paketin alýcýsý eðer gizli anahtara eriþimi varsa bu HMAC'i kontrol edebilir.</p><p>IPsec protokolleri IP datagramlarýnýn gizliliðini korumak için standat simetik þifreleme algoritmalarýný kullanýr. IPsec standartý NULL ve DES gerçeklenimlerine ihtiyaç duysa da günümüzde genel olarak 3DES, AES ve Blowfish gibi daha güçlü algoritmalar kullanýlmaktadýr.</p><p>IPsec protokolleri DoS ataklarýna karþý korunmak için kayan pencere kullanýrlar. Her paketin ardýþýk bir numarasý vardýr ve bir paket sadece numarasýnýn pencerede olmasý veya daha yeni olmasý durumunda kabul edilir. Eski paketler hýzla gözardý edilirler. Böylece saldýrganýn orjinal paketleri kaydedip daha sonra yanýtlamasýyla yapýlan cevaplama saldýrýlarýna karþý koruma saðlanmýþ olur.</p><p>IPsec paketlerini karþýlýklý olarak kapsülleyip açabilen eþlerin gizli anahtarý, algoritmalarý ve iletiþimde izin verilen IP adreslerini saklamak için bir yönteme ihtiyaçlarý vardýr. IP datagramlarýnýn korunmasý için ihtiyaç duyulan bütün bu parametreler bir güvenlik anlaþmasýnda (security association) (SA) saklanýr. Güvenlik anlaþmalarý sýrayla güvenlik anlaþmalarý veritabanýnda (SAD) saklanýrlar.</p><p>Her bir güvenlik anlaþmasý aþaðýdaki parametreleri tanýmlar:
			<div class="itemizedlist"><ul type="disc"><li>Oluþan IPsec baþlýðýnýn hedef ve kaynak IP adresleri. Bu adresler paketleri koruyan IPsec eþlerinin IP adresleridir.</li><li>IPsec protokolü (AH veya ESP), bazen sýkýþtýrma (IPCOMP) da desteklenir.</li><li>IPsec protokolünün kullandýðý gizli anahtar ve protokol.</li><li>Güvenlik Parametre Dizini (Security Parameter Index - SPI). Bu güvenlik anlaþmasýný belirleyen 32-bit bir sayýdýr.</li></ul></div>
		</p><p>Bazý güvenlik anlaþmasý veritabaný gerçeklenimleri baþka parametrelerin de saklanmasýna izin verir:
			<div class="itemizedlist"><ul type="disc"><li>IPsec modu (tünel veya taþýma)</li><li>Cevap ataklarýna karþý koruma saðlayan kayan pencerenin büyüklüðü.</li><li>Güvenlik anlaþmasýnýn geçerlilik süresi.</li></ul></div>
		</p><p>Güvenlik anlaþmasý kaynak ve hedef IP adreslerini tanýmladýðýndan çift yönlü IPsec iletiþiminde sadece bir yöndeki trafikte koruma saðlayabilir. IPsec her iki yönde de koruma saðlamak için iki adet tek yönlü güvenlik anlaþmasýna ihtiyaç duyar.</p><p>Güvenlik anlaþmalarý sadece IPsec'in trafiði nasýl koruyacaðýný belirlerler. Hangi trafiðin ne zaman korunacaðýný tanýmlamak için ilave bilgiye ihtiyaç duyulur. Bu bilgi günelik anlaþmasý veritabanýnda bulundurulan güvenlik politikasýnda (SP) saklanýr.</p><p>Bir güvenlik politikasý aþaðýdaki parametreleri belirler:
			<div class="itemizedlist"><ul type="disc"><li>Korunacak paketlerin kaynak ve hedef adresleri. Taþýma modunda bu adresler SA'daki adreslerle ayný olurlar! Tünel modunda farklý olabilirler!</li><li>Korunacak protokol (ve port). Bazý IPsec gerçeklenimleri özel protokolün korunmak için tanýmlanmasýn aizin vermezler. Böyle bir durumda belirtilen IP adresleri arasýndaki tüm trafik korunur.</li><li>Paketlerin korunmasýnda kullanýlacak güvenlik anlaþmasý.</li></ul></div>
		</p><p>Güvenlik anlaþmasýnýn elle yapýlandýrýlmasý hataya yatkýn ve çok gðvenli de deðildir. Gizli anahtarlarýn ve þifreleme algoritmalarýnýn sanal özel aðdaki tüm eþler arasýnda faylaþýlmasý gerekir. Özellikle anahtarlarýn deðiþimi sistem yöneticisi için kritik problemler yaratýr: Henüz bir þifreleme saðlanmamýþken simetrik anahtarlarýn deðiþimi nasýl yapýlacaktýr?</p><p>Bu problemin çözümü için internet anahtar deðiþim protokolü (IKE) geliþtirilmiþtir. Bu protokol ilk olarak eþlerin kimlik denetimini yapar, ardýndan güvenlik anlaþmalarý tertip edilir ve simetrik anahtarlar Diffie Hellmann anahtar deðiþimi kullanýlarak seçilir. IKE protokolü gizli anahtarlarýn güvenliðinden emin olmak için periyodik olarak yapýlacak anahtar yenilemelerinde de devreye girer.</p></dd></div></dl><dl><div class="sect2"><dt><div> <h3 class="title"><a name="ipsec-howto-theory-protocols"></a>IPsec Protokolleri</h3></div></dt><dd><p>IPsec protokol ailesi iki baðýmsýz IP protokolünden oluþur: Kimlik Kanýtlama Baþlýðý (AH) ve Kapsüllenen Güvenlik Yükü (ESP). AH 51 ve ESP ise 50 numaralý protokollerdir (ayrýntý için <tt>/etc/protocols</tt> dosyasýna bakabilirsiniz). Aþaðýdaki iki bölümde bu protokollerin özelliklerini özet olarak bulacaksýnýz.</p><dl><div class="sect3"><dt><div> <h4 class="title"><a name="ipsec-howto-theory-protocols-ah"></a>AH - Kimlik Kanýtlama Baþlýðý</h4></div></dt><dd><p>AH protokolü IP datagramýnýn bütünlüðünü korur. Bunu yapabilmek için datagramýn HMAC'ini hesaplar. HMAC hesaplanýrken gizli anahtar, paketteki kullanýcý verisi ve IP baþlýðýndaki IP adresi gibi deðiþmeyen bölümleri temel alýnýr. Bu bilgi daha sonra paketin AH baþlýðýna eklenir. AH baþlýðý <a href="../howto/ipsec-howto-theory.html#ipsec-howto-ah_header" title="Þekil 4.2. Paketin bütünlüðünü koruyan AH Baþlýðý">Þekil 4.2</a>'de gösterilmektedir.</p><p><div class="figure"><p><a name="ipsec-howto-ah_header"></a><b>Þekil 4.2. Paketin bütünlüðünü koruyan AH Baþlýðý</b></p><div class="mediaobject"><img src="images/ipsec/ah_header.png" align="center"></div></div></p><p>AH baþlýðý 24 byte uzunluðundadýr. Ýlk byte <i>Next Header</i> alanýdýr. Bu alan takip eden baþlýðýn protokolünü belirtir. Tünel modunda bütüm IP datagramý kapsüllendiðinden bu alanýn deðeri 4'tür. Bir TCP datagramý taþýma modunda kapsüllendiðinde kullanýlan sayý ise 6'dýr. Sonraki byte yükün uzunluðunu gösterir. Bu alaný iki adet ayýrýlmýþ byte takip eder. Sýradaki 32 bit uzunluðundaki alanda <i>Güvenlik Parametre Dizini</i> (SPI) bulunur. SPI, kapsüllenmiþ paketin açýlmasýnda kullanýlacak güvenlik anlaþmasýný belirler. 32 bit uzunluðundaki <i>Ardýþýklýk Numarasý</i> cevaplama ataklarýna karþý koruma saðlar. Son alan olan <i>HMAC</i> ise 96 bitlik alan kaplar. Sadece gizli anahtarý bilen eþler HMAC yaratýp onu kontrol edebildiklerinden HMAC alaný paketin bütünlüðünü korur.</p><p>AH protokolü IP datagramýnýn IP baþlýðýndaki IP adresi gibi deðiþmeyen parçalarýný da koruduðundan NAT'a izin vermez. Að Adresi Çeviricisi (NAT) IP baþlýðýndaki IP adresini (genellikle kaynak IP) baþka bir IP adresiyle deðiþtirir. Böylece HMAC deðiþeceðinden artýk geçersiz olur. IPsec protokolünün bir geniþletmesi olan Aykýrý-NAT bu kýsýtlamanýn etrafýndan dolanan bir çözümdür.</p></dd></div></dl><dl><div class="sect3"><dt><div> <h4 class="title"><a name="ipsec-howto-theory-protocols-esp"></a>ESP - Kapsüllenen Güvenlik Yükü</h4></div></dt><dd><p>ESP protokolü hem HMAC kullanarak paketin bütünlüðünü hem de þifreleme kullanarak paketin gizliðini garanti eder. Paketin þifrelendikten sonra HMAC hesaplanýr ve ESP baþlýðý oluþturulur ve pakete eklenir. Ýki bölümden oluþan ESP baþlýðý <a href="../howto/ipsec-howto-theory.html#ipsec-howto-esp_header" title="Þekil 4.3. ESP Baþlýðý">Þekil 4.3</a>'de gösterilmiþtir.</p><p><div class="figure"><p><a name="ipsec-howto-esp_header"></a><b>Þekil 4.3. ESP Baþlýðý</b></p><div class="mediaobject"><img src="images/ipsec/esp_header.png"></div></div></p><p>ESP baþlýðýndaki ilk bölüm <i>Güvenlik Parametre Dizini</i> (SPI)'dir. SPI kapsüllenmiþ ESP paketinin açýlmasýnda kullanýlacak SA'yý belirtir. Ýkinci bölüm <i>Ardýþýklýk Numarasý</i>dýr. Bu numara cevaplama ataklarýna karþý koruma saðlar. Üçüncü bölümde ise þifreleme iþleminde kullanýlan <i>Ýlklendirme Vektörü</i> (IV) bulunur. Simetrik þifreleme algoritmalarý eðer IV kullanýlmazsa frekans saldýrýlarýna karþý zayýftýrlar. IV sayasinde iki eþit yüke karþýlýk iki farklý þifrelenmiþ yük oluþtuðundundan emin olunabilir.</p><p>IPsec þifreleme sürecinde blok þifreleme algoritmalarý kullandýðýndan eðer þifrelenecek yükün uzunluðu bir bloðun tam katý deðilse takviye edilmelidir. Bu takviyenin uzunluðu da baþlýða eklenir. Bunun ardýndan <i>Next Header</i> bölümü gelir. ESP baþlýðýnda son olarak  paketin bütünlüðünden emin olunmasýný saðlayan 96 bit uzunluðundaki HMAC bulunur. IP baþlýðý hesaplama sürecine dahil edilmez.</p><p>Bu yüzden ESP protokolü NAT kullanýmýna mani olmaz. Yine de bir çok durumda IPsec ile NAT'ýn beraber kullanýmý mümkün olmamaktadýr. Aykýrý-NAT ESP paketlerini UDP paketlerinin içine kapsülleyen bir çözüm sunar.</p></dd></div></dl></dd></div></dl><dl><div class="sect2"><dt><div> <h3 class="title"><a name="ipsec-howto-theory-ike"></a>IKE Protokolü</h3></div></dt><dd><p>IKE protokolü güvenli iletiþimin en ünlü sorununu çözer: eþlerin kimlik kanýtlama yapmasý ve simetrik anahtarlarýn deðiþimi. Bu sayede güvenlik anlaþmalarý yapýlýr ve SAD oluþturulur. IKE protokolü genellikle kullanýcý tarafý sürecine ihtiyaç duyar, iþletim sisteminde bir gerçekleþtirmesi yoktur. Ýletiþim için 500/UDP portunu kullanýr.</p><p>IKE protokol fonksiyonlarý iki safhalýdýr. Ýlk safhada <i>Internet Güvenlik Anlaþmasý Anahtar Yönetimi Güvenlik Anlaþmasý</i> (ISAKMP SA) tesis edilir. Ýkinci safhada ISAKMP SA kullanýlarak IPsec SA'larý kurulur.</p><p>Ýlk safhada eþlerin kimlik kanýtlamasý RSA anahtarlarý veya X.509 sertifikalarý (hatta Kerberos desteðindeki racoon) gibi daha önceden paylaþýlan anahtarlara dayanarak yapýlýr.</p><p>Ýlk safha genellikle iki farklý modu destekler: temel mod ve saldýrgan mod. Ýki mod da eþlerin kimlik kanýtlamasýný yapar ve bir ISAKMP SA oluþturur ama saldýrgan mod bu iþi yapmak için temel modun yarýsý kadar mesaj kullanýr. Bunun sakýncasý saldýrgan modun kimlik korumasýný desteklemediðinden eðer önceden paylaþýlmýþ anahtarlarla birlikte kullanýlýrsa aradaki-adam saldýrýlarýna karþý 
			This does have its drawbacks though, because the aggressive mode does not support identity protection and is therefore susceptible to a man-in-the-middle attack if used in conjunction with pre-shared keys. On the other hand this is the only purpose of the aggressive mode. Because of the internal workings of the main mode it does not support the usage of different preshared keys with unknown peers. The aggressive mode does not support identity protection and transfers the identity of the client in the clear. The peers therefore know each other before the authentication takes place and different pre-shared keys can be used for different peers.</p><p>In the second phase the IKE protocol exchanges security association proposals and negotiates the security associations based on the ISAKMP SA. The ISAKMP SA provides the authentication to protect against a man-in-the-middle attack. This second phase uses the quick mode.</p><p>Usually two peers negotiate only one ISAKMP SA, which is then used to negotiate several (at least two) unidirectional IPsec SAs.</p></dd></div></dl><dl><div class="sect2"><dt><div> <h3 class="title"><a name="ipsec-howto-theory-nat"></a>Aykýrý NAT</h3></div></dt><dd><p>What is NAT-Traversal and why is it needed?</p><p>Often one peer in the VPN is behind a NAT-device. I just assume Source-NAT devices here. Whenever I talk about NAT I mean Source-NAT or Masquerading. What does this mean concerning the VPN? Well, first of all the original IP address of the peer is hidden by the NAT-device. The NAT-device conceals the original source IP address and replaces it by its own IP address.</p><p>This make the IPsec AH protocol immediately unusable. But ESP can still be used if both sides are configured correctly.</p><p>So why do you need NAT-Traversal? Because as soon as two machines behind the same NAT device try to build a tunnel to the outside, both will fail.</p><p>Why is this happening? The NAT device needs to keep track of the "natted" connections to be able to "de-nat" the reply packets back to the original client. Therefore the NAT device maintains an internal table where all "natted" connections are stored. Lets assume one client connects to a webserver on the Internet. The NAT device conceils the original address by replacing it with its own address. It then makes a note in its internal table that all packets coming back on the chosen client port have to be send to the original client1. As soon as the second client starts a connection, it handles that connection identical. If the second client chose the same client port by coincidence the NAT device will also modify the client port for unambuigity. This works very well using TCP and UDP because those protocols provide ports. ESP does not use ports. Therefore the NAT device can only use the protocol distinguish the packets. When the first client connects it stores the information in the table that all ESP packets have to be "denatted" to the first client. When the second client connects it will overwrite this entry with the appropiate entry for the second one thus breaking at least the first connection.</p><p>What does NAT traversal do to help? NAT-traversal again encapsulates the ESP packets in UDP packets. These can easily be handled by a NAT device since they provide ports. By default port 4500/udp is used. NAT traversal is specified in several drafts. There are no RFCs at the moment. A nice feature of NAT traversal is the fact that once activated the peers automatically use it when needed.</p></dd></div></dl></dd></div></dl><h1></h1><table width="100%" summary="Navigation header" cellpadding="1" cellspacing="0" border="0"><tr><td bgcolor="black" class="navoutline"><table width="100%" cellpadding="0" cellspacing="0" border="0"><tr><td bgcolor="white" class="navinline"><table width="100%" cellpadding="3" cellspacing="0" border="0"><tr><td width="40%" align="left"><a accesskey="p" href="../howto/ipsec-howto-intro.html">Önceki</a> </td><td width="20%" align="center"><a accesskey="u" href="../howto/ipsec-howto.html">Üst Ana Baþlýk</a></td><td width="40%" align="right"> <a accesskey="n" href="../howto/ipsec-howto-openswan.html">Sonraki</a></td></tr><tr><td width="40%" align="left" valign="top">Giriþ </td><td width="20%" align="center"><a accesskey="h" href="../KiTAPLIK/index.html">Baþlangýç</a></td><td width="40%" align="right" valign="top"> Linux 2.6 Üzerinde Çalýþan Openswan</td></tr><tr><td colspan="3" align="center">
                  Bir <a href="http://www.belgeler.org/">Linux Kitaplýðý</a> Sayfasý
                </td></tr></table></td></tr></table></td></tr></table></body></html>
